<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KY Lake Levels</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #0d1117;
            color: white;
        }

        .container {
            width: 95%;
            max-width: 1400px;
            margin: auto;
            padding-top: 20px;
        }

        h1 {
            text-align: left;
            margin-bottom: 5px;
        }

        #updateStatus {
            float: right;
            background: #111827;
            padding: 8px 14px;
            border-radius: 12px;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #1f2937;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background-color: #111827;
        }

        tr:nth-child(odd) {
            background-color: #0f172a;
        }

        /* flood chart container */
        #chartContainer {
            background: #111827;
            margin-top: 25px;
            padding: 20px;
            border-radius: 12px;
        }

        .boat-mode {
            background-color: white !important;
            color: black !important;
        }

        .boat-mode table tr:nth-child(even) {
            background-color: #e3e3e3 !important;
        }
        .boat-mode table tr:nth-child(odd) {
            background-color: #f5f5f5 !important;
        }

        /* chart colors for bright mode */
        .boat-mode canvas {
            filter: invert(1) hue-rotate(180deg);
        }

        /* ======================
           DISCLAIMER POPUP
        ====================== */
        #disclaimerPopup {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.65);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            visibility: hidden;
            opacity: 0;
            transition: 0.3s;
        }

        #disclaimerPopup.show {
            visibility: visible;
            opacity: 1;
        }

        .popup-box {
            background: #1f2937;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 420px;
            text-align: center;
            color: white;
        }

        .popup-box button {
            margin-top: 15px;
            padding: 8px 15px;
            border: none;
            background: #3b82f6;
            color: white;
            font-size: 1rem;
            border-radius: 6px;
        }

        /* ======================
           BOTTOM DISCLAIMER
        ====================== */
        footer.disclaimer-footer {
            width: 100%;
            text-align: center;
            padding: 20px;
            font-size: 0.8rem;
            opacity: 0.6;
            color: #ccc;
            margin-top: 40px;
        }

        .boat-mode footer.disclaimer-footer {
            color: #000;
            opacity: 0.75;
        }
    </style>
</head>
<body>

<div class="container">

    <h1>KY Lake Levels</h1>
    <div id="updateStatus">Updated: loading…</div>
    <br><br>

    <!-- BOAT MODE SWITCH -->
    <label>
        <input type="checkbox" id="boatMode"> Boat mode (bright)
    </label>

    <!-- LAKE TABLE -->
    <table id="lakeTable">
        <thead>
            <tr>
                <th>Basin</th>
                <th>Project</th>
                <th>Pool</th>
                <th>Dev.</th>
                <th>24h Δ</th>
                <th>Rain</th>
                <th>Inflow</th>
                <th>Outflow</th>
                <th>% Util</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="9">Loading live lake data…</td></tr>
        </tbody>
    </table>

    <!-- FLOOD STORAGE CHART -->
    <div id="chartContainer">
        <h3>Flood Pool Utilization (% of flood storage used)</h3>
        <canvas id="floodChart" height="380"></canvas>
    </div>

</div>

<!-- ======================
     BOTTOM DISCLAIMER
====================== -->
<footer class="disclaimer-footer">
    <p>
        <strong>Disclaimer:</strong> This application is not affiliated with, endorsed by, or sponsored by
        the U.S. Army Corps of Engineers. All lake data is publicly available from the USACE Water Management website.
        Accuracy is not guaranteed.
    </p>
</footer>

<!-- ======================
     DISCLAIMER POPUP (one-time)
====================== -->
<div id="disclaimerPopup">
    <div class="popup-box">
        <h3>Disclaimer</h3>
        <p>
            This app is NOT affiliated with, endorsed by, or sponsored by the U.S. Army Corps of Engineers.
            Data is sourced from publicly available USACE systems. Accuracy is not guaranteed.
        </p>
        <button id="closePopup">I Understand</button>
    </div>
</div>


<!-- ======================
     SCRIPTS
====================== -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ------------------------------
   BOAT MODE
------------------------------ */
const boatToggle = document.getElementById("boatMode");

boatToggle.addEventListener("change", () => {
    const page = document.body;

    if (boatToggle.checked) {
        page.classList.add("boat-mode");
    } else {
        page.classList.remove("boat-mode");
    }

    if (window.drawFloodChart) {
        drawFloodChart(window.lastLakeData);
    }
});

/* ------------------------------
   ONE-TIME DISCLAIMER POPUP
------------------------------ */
document.addEventListener("DOMContentLoaded", () => {
    if (!localStorage.getItem("acceptedDisclaimer")) {
        document.getElementById("disclaimerPopup").classList.add("show");
    }
});

document.getElementById("closePopup").addEventListener("click", () => {
    localStorage.setItem("acceptedDisclaimer", "yes");
    document.getElementById("disclaimerPopup").classList.remove("show");
});

/* ------------------------------
   FETCH LAKE DATA
------------------------------ */
async function loadLakes() {
    try {
        const res = await fetch("https://ky-lake-backend.onrender.com/lakes");
        const json = await res.json();

        window.lastLakeData = json.lakes;
        populateTable(json.lakes);
        drawFloodChart(json.lakes);

        document.getElementById("updateStatus").innerHTML =
            "Updated: " + new Date(json.timestamp).toLocaleString() +
            "<br>Loaded " + json.lakes.length + " lakes";

    } catch (err) {
        document.getElementById("updateStatus").innerText = "Error loading data";
    }
}

function populateTable(lakes) {
    const tbody = document.querySelector("#lakeTable tbody");
    tbody.innerHTML = "";

    lakes.forEach(lake => {
        const row = `
            <tr>
                <td>${lake.basin}</td>
                <td>${lake.project}</td>
                <td>${lake.todayPool}</td>
                <td>${lake.deviation}</td>
                <td>${lake.change24h}</td>
                <td>${lake.precip24h}</td>
                <td>${lake.inflow}</td>
                <td>${lake.outflow}</td>
                <td>${lake.percentUtil}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

/* ------------------------------
   FLOOD CHART
------------------------------ */
let floodChart;

function drawFloodChart(lakes) {
    const ctx = document.getElementById("floodChart").getContext("2d");

    const names = lakes.map(a => a.project);
    const values = lakes.map(a => a.percentUtil);

    if (floodChart) floodChart.destroy();

    const textColor = document.body.classList.contains("boat-mode") ? "black" : "white";

    floodChart = new Chart(ctx, {
        type: "horizontalBar",
        data: {
            labels: names,
            datasets: [{
                label: "% Utilized",
                data: values,
                backgroundColor: "#38bdf8"
            }]
        },
        options: {
            scales: {
                xAxes: [{
                    ticks: { fontColor: textColor }
                }],
                yAxes: [{
                    ticks: { fontColor: textColor }
                }]
            },
            legend: {
                labels: { fontColor: textColor }
            }
        }
    });
}

/* ------------------------------
   Load on page open
------------------------------ */
loadLakes();
</script>

</body>
</html>
